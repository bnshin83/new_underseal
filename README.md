# New Underseal

## Overview
This project is designed for management of INDOT FWD data. It mainly consists of two parts: **Processing LongList(LL) Requests** and **Processing F25**, with other **Separate Scripts** provided for other functionalities (e.g., fixing the F25 format, fill missing GPS, etc.). The code base **needs be cleaned for better readability** since some files and functions are no longer used. In addition, part of the FWD calculation is based on legacy Fortran code (i.e., we refer to it as Egon's code). Sometime the F25 Processing failed because of the legacy Fortran code. A re-implementation of the legacy code is something that could be beneficial.

## Installation
Please refer to the Manual of SPR-4450

## Overall Workflow of FWD data collection and processing
At each quarter of FWD data collection seasons, different INDOT districts would request FWD on different road sections. These requests would handled by a Excel file called LongList file. 

In the LongList file, there would be a LL entry on each row and each LL entry correspond to a FWD request. Each request would have an unique Request Number. Similarly, a combination of Year and LL Number (LL NO.) can also serve as the unique identifier for each FWD request. The LL NO. is usually determined by the order of the LL entry in the excel.

The FWD requests would be uploaded to the Oracle database using  

## Modules of New Underseal

### LL Requests Uploading Module
To upload the LL requests to Oracle database, run:

```
python upload_ll_batch.py
```
It will pop up a window and ask the user to pick the Excel file. The LL entires in the Excel file would be uploaded to the Oracle database. 


### Processing F25 Module
This sub-module is responsible for processing raw F25 files and uploading the calculation results (e.f., modulus residue(MR), Structure Number (SN), etc.) to the Oracle database. 

It needs the raw F25 file and the corresponding .mde file as input (in practice, user specify the F25 file path in a txt, and then the program will find the corresponding .mde file). The corresponding .mde file is generated by ELMOD using the raw F25 as input.

Main portion of the code base is for this module. So you might starts from the **upload_results_batch_f25only.py** script and dig through the functions to see how it is implemented. Write your own unit test for deeper understanding of the functions.

The LL entry correspond to the F25 must be uploaded to the Oracle database before running the F25 Processing Module.

To process F25 and upload the calculation results:
```
python upload_results_batch_f25only.py --txt_path <txt path> --user_input --gen_report 
```
\<txt path\> is the txt that each line in the txt is a path to a unique F25 file. You need to create a txt that contains batch of F25 files before running the script. The script would take the txt as input, read each line and find the F25 and the corresponding .mde file (.mde file and the F25 file shares the same name except for the extension name).

--user_input is the flag for special case such as airport FWD test. In this mode, the user can input the related F25 info manually as the program cannot detect the F25 info from the filename automatically.

--pavtype_special_case flag lets the user to specify the pavement type manually. By default, the program detect the pavement type (Asphalt/Composite/Concrete) automatically using the modulus calculated by ELMOD.

--gen_report flag decides whether to generate the .docx report or not. 

--skip_img_matching flag can be used to skip the image matching process because the user might want to skip the image uploading for historical FWD data.

--gui flag lets the user to pick the \<txt path\> using a GUI.


### Separate Scripts Module
- **correct_f25_format.py**: Fixing the indentation issue of F25. By default, F25 should have 3 spaces in front of the drop number. However, some F25 does not and would cause a error when feeding the F25 through ELMOD. To run the script:
```
python correct_f25_format.py --path <insert your f25 path here>
``` 
â€‹It will generate a new f25 with the correct format under the same folder where your original f25 is located. If there is no format issue in the original f25, it will not generate the new f25 file.

- **fill_gps.py**: If the GPS is provided in a separate csv file and the GPSX and GPSY are missing in the STDA_DEFLECTIONS table. This script would fill the GPSX and GPSY column. To run:
```
python fill_gps.py
```
and then follow the pop-up window to choose the txt file that contains a bunch of CSV file path. Please note that there is a naming convention for the CSV file:

>The name of the CSV file has to match the name of the F25 with " gps" appended. For example, the F25 filename is "XXX.F25", then the gps csv file should be "XXX gps.csv". Notice a space between "XXX" and "gps".


- **split_se_f25.py**: Under development. There are edge cases that needs to be handled. Need to discuss the edge cases with Dr. Shin. The aim is to split a F25 file that contains varying pavement type and depth into multiple F25 files depends on the breakpoint chosen by the user. After splitting, the depth and pavement type of the test points in a single F25 file would be similar.


## Database Schema
Below are the essential tables. There might be other tables in the INDOT database. But those are not related to New Underseal.

For each FWD request, there will be multiple F25 files generated during the FWD field test, as pavement sections in different lanes and directions need to be tested separately. Each F25 correspond to one FWD test. Each FWD test has it own unique LL ID (LONGLIST_ID in the tables). 

- **STDA_LONGLIST_INFO**: Filled by running the LL Requests Uploading Module.

These tables below are filled by running the Processing F25 Module
- **STDA_CALCULATED_DEFLECTIONS**
- **STDA_CALCULATIONS**
- **STDA_DEFLECTIONS**
- **STDA_LONGLIST**
- **STDA_MISC**
- **STDA_MODULI_ESTIMATED**
- **STDA_STATS**
- **STDA_IMG**: Stores the URL of the image in INDOT image server. Each (Request_NO, DIRECTION, CHAINAGE_FT) combination would map to one or more images because multiple images might be taken around a single FWD test point. The dashboard use the URLs in this table to fetch the image. 



## Deprecated Scripts:
- sync_ll_2022_6_28.py

## Files not related to New Underseal
In the codebase, there are going to be files that are not in the workflow of New Underseal (e.g., check_size.sql, workflow.rb and so on). I did not clean those files as I am not sure if Dr. Shin is going to need them in the future. You would know a file is not related to the New Underseal if the file is not imported or called in scripts mentioned in **Modules of New Underseal** section.

## For code review and understanding
If would recommend starts with scripts mentioned in **Modules of New Underseal** section. All the scripts in the **Modules of New Underseal** section can be seen as the "main file" as each of them is responsible for different functionalities and can be used independently from each other.
